name: Build Aseprite

on:
  workflow_dispatch:
    inputs:
      aseprite_version:
        description: 'Aseprite version tag (e.g. v1.3.7), or leave blank for latest'
        required: false
        default: ''
  schedule:
    # Check for new releases weekly on Mondays at 08:00 UTC
    - cron: '0 8 * * 1'

jobs:
  build:
    name: Build Aseprite (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows
            runner: windows-latest
            artifact: aseprite-windows
            skia_asset_pattern: 'Windows-Release-x64.zip'
          - os: linux
            runner: ubuntu-22.04
            artifact: aseprite-linux
            skia_asset_pattern: 'Linux-Release-x64.zip'
          - os: macos
            runner: macos-14
            artifact: aseprite-macos
            skia_asset_pattern: 'macOS-Release-arm64.zip'

    steps:
      # ── Resolve Aseprite version ──────────────────────────────────────────────
      - name: Resolve Aseprite version
        id: aseprite_ver
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.event.inputs.aseprite_version }}"
          if [ -z "$VERSION" ]; then
            VERSION=$(gh release view --repo aseprite/aseprite --json tagName -q '.tagName')
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Resolved Aseprite version: $VERSION"

      # ── Check build cache ─────────────────────────────────────────────────────
      - name: Restore build cache
        id: cache
        uses: actions/cache@v4
        with:
          path: aseprite-build
          key: aseprite-${{ matrix.os }}-${{ steps.aseprite_ver.outputs.version }}

      # ── Checkout Aseprite source ──────────────────────────────────────────────
      - name: Checkout Aseprite
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          repository: aseprite/aseprite
          ref: ${{ steps.aseprite_ver.outputs.version }}
          submodules: recursive

      # ── Resolve the correct Skia release tag ──────────────────────────────────
      #
      #   Skia release tags look like:  m124-08a5439a6b
      #   Skia asset names look like:   Skia-m124-08a5439a6b-Windows-Release-x64.zip
      #
      #   We read the milestone from Aseprite's DEPS file, then use `gh` CLI
      #   (pre-installed on all runners, handles auth automatically) to find
      #   the matching Skia release — no curl, no guessed URLs, no 404s.
      - name: Resolve Skia release tag
        if: steps.cache.outputs.cache-hit != 'true'
        id: skia
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== DEPS Skia lines ==="
          grep -i skia DEPS || true

          # Extract milestone number from lines like:
          #   'aseprite_skia_branch': 'aseprite-m124',
          MILESTONE=$(grep -oP "aseprite-m\K\d+" DEPS 2>/dev/null | head -1)

          if [ -z "$MILESTONE" ]; then
            # Fallback: inspect the checked-out skia submodule's tracking branch
            MILESTONE=$(git -C third_party/skia branch -r 2>/dev/null \
              | grep -oP "aseprite-m\K\d+" | head -1)
          fi

          MILESTONE="m${MILESTONE:-124}"
          echo "Skia milestone: $MILESTONE"

          echo "=== Listing aseprite/skia releases ==="
          ALL_TAGS=$(gh release list \
            --repo aseprite/skia \
            --limit 50 \
            --json tagName \
            --jq '.[].tagName')
          echo "$ALL_TAGS"

          TAG=$(echo "$ALL_TAGS" | grep "^${MILESTONE}-" | head -1)

          if [ -z "$TAG" ]; then
            echo "ERROR: No Skia release found matching '${MILESTONE}-*'"
            exit 1
          fi

          echo "Resolved Skia tag: $TAG"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      # ── Download the Skia platform asset ─────────────────────────────────────
      #   `gh release download` handles GitHub auth + redirects automatically.
      - name: Download Skia
        if: steps.cache.outputs.cache-hit != 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ASSET_PATTERN: ${{ matrix.skia_asset_pattern }}
        run: |
          echo "Downloading Skia ${{ steps.skia.outputs.tag }} / *${ASSET_PATTERN}"
          mkdir skia-dl
          gh release download "${{ steps.skia.outputs.tag }}" \
            --repo aseprite/skia \
            --pattern "*${ASSET_PATTERN}" \
            --dir skia-dl
          echo "Downloaded:"
          ls -lh skia-dl/

      # ── Extract Skia ──────────────────────────────────────────────────────────
      - name: Extract Skia
        if: steps.cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          mkdir skia
          ZIP=$(ls skia-dl/*.zip | head -1)
          echo "Extracting: $ZIP"
          if command -v 7z &>/dev/null; then
            7z x "$ZIP" -oskia -y
          else
            unzip -q "$ZIP" -d skia
          fi
          echo "Skia contents:"
          ls skia/

      # ── Install Linux dependencies ────────────────────────────────────────────
      - name: Install Linux dependencies
        if: steps.cache.outputs.cache-hit != 'true' && matrix.os == 'linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            cmake ninja-build clang \
            libx11-dev libxcursor-dev libxi-dev libxrandr-dev \
            libgl1-mesa-dev libfontconfig1-dev

      # ── Install Windows dependencies ──────────────────────────────────────────
      - name: Install Windows dependencies
        if: steps.cache.outputs.cache-hit != 'true' && matrix.os == 'windows'
        run: choco install ninja --no-progress -y

      - name: Set up MSVC (Windows)
        if: steps.cache.outputs.cache-hit != 'true' && matrix.os == 'windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # ── CMake configure: Windows ──────────────────────────────────────────────
      - name: Configure CMake (Windows)
        if: steps.cache.outputs.cache-hit != 'true' && matrix.os == 'windows'
        shell: cmd
        run: |
          mkdir build
          cd build
          cmake .. ^
            -G Ninja ^
            -DCMAKE_BUILD_TYPE=RelWithDebInfo ^
            -DLAF_BACKEND=skia ^
            -DSKIA_DIR="%GITHUB_WORKSPACE%\skia" ^
            -DSKIA_LIBRARY_DIR="%GITHUB_WORKSPACE%\skia\out\Release-x64" ^
            -DSKIA_LIBRARY="%GITHUB_WORKSPACE%\skia\out\Release-x64\skia.lib"

      # ── CMake configure: Linux ────────────────────────────────────────────────
      #   -stdlib=libstdc++ required when linking pre-built Skia (per INSTALL.md)
      - name: Configure CMake (Linux)
        if: steps.cache.outputs.cache-hit != 'true' && matrix.os == 'linux'
        run: |
          export CC=clang
          export CXX=clang++
          mkdir build && cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_CXX_FLAGS="-stdlib=libstdc++" \
            -DCMAKE_EXE_LINKER_FLAGS="-stdlib=libstdc++" \
            -DLAF_BACKEND=skia \
            -DSKIA_DIR="$GITHUB_WORKSPACE/skia" \
            -DSKIA_LIBRARY_DIR="$GITHUB_WORKSPACE/skia/out/Release-x64" \
            -DSKIA_LIBRARY="$GITHUB_WORKSPACE/skia/out/Release-x64/libskia.a"

      # ── CMake configure: macOS ────────────────────────────────────────────────
      - name: Configure CMake (macOS)
        if: steps.cache.outputs.cache-hit != 'true' && matrix.os == 'macos'
        run: |
          mkdir build && cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DLAF_BACKEND=skia \
            -DSKIA_DIR="$GITHUB_WORKSPACE/skia" \
            -DSKIA_LIBRARY_DIR="$GITHUB_WORKSPACE/skia/out/Release-arm64" \
            -DSKIA_LIBRARY="$GITHUB_WORKSPACE/skia/out/Release-arm64/libskia.a"

      # ── Build ─────────────────────────────────────────────────────────────────
      - name: Build
        if: steps.cache.outputs.cache-hit != 'true'
        working-directory: build
        run: ninja aseprite

      - name: Stage output
        if: steps.cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          mkdir -p aseprite-build
          cp -r build/bin/* aseprite-build/

      # ── Upload artifact ───────────────────────────────────────────────────────
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}-${{ steps.aseprite_ver.outputs.version }}
          path: aseprite-build/
          retention-days: 30

  # ── Create a GitHub Release (manual trigger only) ─────────────────────────────
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Resolve Aseprite version
        id: ver
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.event.inputs.aseprite_version }}"
          if [ -z "$VERSION" ]; then
            VERSION=$(gh release view --repo aseprite/aseprite --json tagName -q '.tagName')
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Zip artifacts
        run: |
          cd artifacts
          for dir in */; do
            zip -r "${dir%/}.zip" "$dir"
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ steps.ver.outputs.version }}-${{ github.run_number }}
          name: "Aseprite ${{ steps.ver.outputs.version }} (build #${{ github.run_number }})"
          body: |
            Automated build of [Aseprite ${{ steps.ver.outputs.version }}](https://github.com/aseprite/aseprite/releases/tag/${{ steps.ver.outputs.version }}).

            > ⚠️ **Reminder:** Aseprite's source is available under a proprietary EULA.
            > You may build it for **personal use only** — redistribution of binaries is not permitted.
            > Please purchase a licence at https://www.aseprite.org/ to support the developers.
          files: artifacts/*.zip
          draft: false
          prerelease: false