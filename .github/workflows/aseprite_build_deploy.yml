name: Build Aseprite

on:
  workflow_dispatch:
    inputs:
      aseprite_version:
        description: 'Aseprite version tag (e.g. v1.3.7), or leave blank for latest'
        required: false
        default: ''
  schedule:
    # Check for new releases weekly on Mondays at 08:00 UTC
    - cron: '0 8 * * 1'

jobs:
  build:
    name: Build Aseprite (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows
            runner: windows-latest
            artifact: aseprite-windows
            skia_asset_pattern: 'Windows-Release-x64.zip'
          - os: linux
            runner: ubuntu-22.04
            artifact: aseprite-linux
            skia_asset_pattern: 'Linux-Release-x64.zip'
          - os: macos
            runner: macos-14
            artifact: aseprite-macos
            skia_asset_pattern: 'macOS-Release-arm64.zip'

    steps:
      # ── Resolve Aseprite version ──────────────────────────────────────────────
      - name: Resolve Aseprite version
        id: aseprite_ver
        shell: bash
        run: |
          VERSION="${{ github.event.inputs.aseprite_version }}"
          if [ -z "$VERSION" ]; then
            VERSION=$(curl -fsSL \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/aseprite/aseprite/releases/latest" \
              | jq -r '.tag_name')
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Resolved Aseprite version: $VERSION"

      # ── Check cache ───────────────────────────────────────────────────────────
      - name: Restore build cache
        id: cache
        uses: actions/cache@v4
        with:
          path: aseprite-build
          key: aseprite-${{ matrix.os }}-${{ steps.aseprite_ver.outputs.version }}

      # ── Checkout Aseprite ─────────────────────────────────────────────────────
      - name: Checkout Aseprite source
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          repository: aseprite/aseprite
          ref: ${{ steps.aseprite_ver.outputs.version }}
          submodules: recursive

      # ── Resolve Skia release asset URL via GitHub API ─────────────────────────
      #
      #   Skia release tags look like: m124-08a5439a6b
      #   Asset names look like:       Skia-m124-08a5439a6b-Windows-Release-x64.zip
      #
      #   We read the Skia branch from Aseprite's DEPS file (most reliable),
      #   derive the milestone, then query the API to find the matching release
      #   and pick the right platform asset — no URL guessing needed.
      - name: Resolve Skia download URL
        if: steps.cache.outputs.cache-hit != 'true'
        id: skia
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ASSET_PATTERN: ${{ matrix.skia_asset_pattern }}
        run: |
          # 1. Read the Skia branch from Aseprite's DEPS file
          SKIA_BRANCH=$(grep -oP "(?<='aseprite-m)\d+" DEPS 2>/dev/null | head -1)
          if [ -n "$SKIA_BRANCH" ]; then
            MILESTONE="m${SKIA_BRANCH}"
          else
            # Fallback: read from INSTALL.md
            MILESTONE=$(grep -oP 'aseprite-m\d+' INSTALL.md | head -1 | grep -oP 'm\d+')
          fi
          MILESTONE="${MILESTONE:-m124}"
          echo "Skia milestone: $MILESTONE"

          # 2. List Skia releases and find the most recent one for this milestone
          RELEASES=$(curl -fsSL \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/aseprite/skia/releases?per_page=50")

          RELEASE=$(echo "$RELEASES" | jq -r \
            --arg ms "${MILESTONE}-" \
            '[.[] | select(.tag_name | startswith($ms))] | first')

          if [ -z "$RELEASE" ] || [ "$RELEASE" = "null" ]; then
            echo "ERROR: No Skia release found for milestone $MILESTONE"
            echo "Available tags:"
            echo "$RELEASES" | jq -r '.[].tag_name'
            exit 1
          fi

          TAG=$(echo "$RELEASE" | jq -r '.tag_name')
          echo "Skia release tag: $TAG"

          # 3. Find the asset whose name contains our platform pattern
          ASSET_URL=$(echo "$RELEASE" | jq -r \
            --arg pat "$ASSET_PATTERN" \
            '.assets[] | select(.name | contains($pat)) | .browser_download_url' \
            | head -1)

          if [ -z "$ASSET_URL" ]; then
            echo "ERROR: No asset matching '$ASSET_PATTERN' found in release $TAG"
            echo "Available assets:"
            echo "$RELEASE" | jq -r '.assets[].name'
            exit 1
          fi

          echo "Skia asset URL: $ASSET_URL"
          echo "url=$ASSET_URL" >> "$GITHUB_OUTPUT"

      # ── Download and extract Skia ─────────────────────────────────────────────
      - name: Download and extract Skia
        if: steps.cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          curl -fsSL -L -o skia.zip "${{ steps.skia.outputs.url }}"
          mkdir skia
          if command -v 7z &>/dev/null; then
            7z x skia.zip -oskia -y
          else
            unzip -q skia.zip -d skia
          fi
          echo "Skia top-level contents:"
          ls skia/

      # ── Install Linux dependencies ────────────────────────────────────────────
      - name: Install Linux dependencies
        if: steps.cache.outputs.cache-hit != 'true' && matrix.os == 'linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            cmake ninja-build clang \
            libx11-dev libxcursor-dev libxi-dev libxrandr-dev \
            libgl1-mesa-dev libfontconfig1-dev

      # ── Install Windows dependencies ──────────────────────────────────────────
      - name: Install Windows dependencies
        if: steps.cache.outputs.cache-hit != 'true' && matrix.os == 'windows'
        run: choco install ninja --no-progress -y

      - name: Set up MSVC environment (Windows)
        if: steps.cache.outputs.cache-hit != 'true' && matrix.os == 'windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # ── CMake configure: Windows ──────────────────────────────────────────────
      - name: Configure CMake (Windows)
        if: steps.cache.outputs.cache-hit != 'true' && matrix.os == 'windows'
        shell: cmd
        run: |
          mkdir build
          cd build
          cmake .. ^
            -G Ninja ^
            -DCMAKE_BUILD_TYPE=RelWithDebInfo ^
            -DLAF_BACKEND=skia ^
            -DSKIA_DIR="%GITHUB_WORKSPACE%\skia" ^
            -DSKIA_LIBRARY_DIR="%GITHUB_WORKSPACE%\skia\out\Release-x64" ^
            -DSKIA_LIBRARY="%GITHUB_WORKSPACE%\skia\out\Release-x64\skia.lib"

      # ── CMake configure: Linux ────────────────────────────────────────────────
      #   INSTALL.md requires -stdlib=libstdc++ when using pre-built Skia.
      - name: Configure CMake (Linux)
        if: steps.cache.outputs.cache-hit != 'true' && matrix.os == 'linux'
        run: |
          export CC=clang
          export CXX=clang++
          mkdir build && cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_CXX_FLAGS="-stdlib=libstdc++" \
            -DCMAKE_EXE_LINKER_FLAGS="-stdlib=libstdc++" \
            -DLAF_BACKEND=skia \
            -DSKIA_DIR="$GITHUB_WORKSPACE/skia" \
            -DSKIA_LIBRARY_DIR="$GITHUB_WORKSPACE/skia/out/Release-x64" \
            -DSKIA_LIBRARY="$GITHUB_WORKSPACE/skia/out/Release-x64/libskia.a"

      # ── CMake configure: macOS ────────────────────────────────────────────────
      - name: Configure CMake (macOS)
        if: steps.cache.outputs.cache-hit != 'true' && matrix.os == 'macos'
        run: |
          mkdir build && cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DLAF_BACKEND=skia \
            -DSKIA_DIR="$GITHUB_WORKSPACE/skia" \
            -DSKIA_LIBRARY_DIR="$GITHUB_WORKSPACE/skia/out/Release-arm64" \
            -DSKIA_LIBRARY="$GITHUB_WORKSPACE/skia/out/Release-arm64/libskia.a"

      # ── Build ─────────────────────────────────────────────────────────────────
      - name: Build
        if: steps.cache.outputs.cache-hit != 'true'
        working-directory: build
        run: ninja aseprite

      - name: Stage output
        if: steps.cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          mkdir -p aseprite-build
          cp -r build/bin/* aseprite-build/

      # ── Upload artifact ───────────────────────────────────────────────────────
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}-${{ steps.aseprite_ver.outputs.version }}
          path: aseprite-build/
          retention-days: 30

  # ── Create a GitHub Release (manual trigger only) ─────────────────────────────
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Resolve Aseprite version
        id: ver
        shell: bash
        run: |
          VERSION="${{ github.event.inputs.aseprite_version }}"
          if [ -z "$VERSION" ]; then
            VERSION=$(curl -fsSL \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/aseprite/aseprite/releases/latest" \
              | jq -r '.tag_name')
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Zip artifacts
        run: |
          cd artifacts
          for dir in */; do
            zip -r "${dir%/}.zip" "$dir"
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ steps.ver.outputs.version }}-${{ github.run_number }}
          name: "Aseprite ${{ steps.ver.outputs.version }} (build #${{ github.run_number }})"
          body: |
            Automated build of [Aseprite ${{ steps.ver.outputs.version }}](https://github.com/aseprite/aseprite/releases/tag/${{ steps.ver.outputs.version }}).

            > ⚠️ **Reminder:** Aseprite's source is available under a proprietary EULA.
            > You may build it yourself for **personal use only** — redistribution of binaries is not permitted.
            > Please purchase a licence at https://www.aseprite.org/ to support the developers.
          files: artifacts/*.zip
          draft: false
          prerelease: false