name: Build and Publish Aseprite

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

permissions:
  contents: write

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Get latest upstream release info
        id: upstream
        shell: pwsh
        run: |
          $release = Invoke-RestMethod `
            -Uri "https://api.github.com/repos/aseprite/aseprite/releases/latest" `
            -Headers @{ "User-Agent" = "GitHubActions" }

          $tag = $release.tag_name
          $download = $release.assets[0].browser_download_url

          "tag=$tag" >> $env:GITHUB_OUTPUT
          "download=$download" >> $env:GITHUB_OUTPUT

      - name: Check if release already exists
        id: check_release
        shell: pwsh
        run: |
          $existing = gh release view "${{ steps.upstream.outputs.tag }}" 2>$null
          if ($LASTEXITCODE -eq 0) {
            "exists=true" >> $env:GITHUB_OUTPUT
          } else {
            "exists=false" >> $env:GITHUB_OUTPUT
          }

      - name: Stop if release exists
        if: steps.check_release.outputs.exists == 'true'
        run: echo "Release already exists. Skipping build."

      - name: Install Ninja (if missing)
        if: steps.check_release.outputs.exists == 'false'
        run: choco install ninja --no-progress -y

      - name: Download Skia
        if: steps.check_release.outputs.exists == 'false'
        shell: pwsh
        run: |
          curl -L -o skia.zip `
          https://github.com/aseprite/skia/releases/download/m81-b607b32047/Skia-Windows-Release-x64.zip
          Expand-Archive skia.zip -DestinationPath skia

      - name: Download Aseprite source
        if: steps.check_release.outputs.exists == 'false'
        shell: pwsh
        run: |
          curl -L -o aseprite.zip `
          "${{ steps.upstream.outputs.download }}"
          Expand-Archive aseprite.zip -DestinationPath aseprite
          New-Item -ItemType Directory -Path aseprite/build

      - name: Configure MSVC environment
        if: steps.check_release.outputs.exists == 'false'
        uses: microsoft/setup-msbuild@v2

      - name: Configure CMake
        if: steps.check_release.outputs.exists == 'false'
        working-directory: aseprite/build
        run: |
          cmake -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ^
                -DLAF_BACKEND=skia ^
                -DSKIA_DIR=../../skia ^
                -DSKIA_LIBRARY_DIR=../../skia/out/Release-x64 ^
                -G Ninja ..

      - name: Build
        if: steps.check_release.outputs.exists == 'false'
        working-directory: aseprite/build
        run: ninja aseprite

      - name: Prepare portable build
        if: steps.check_release.outputs.exists == 'false'
        working-directory: aseprite/build/bin
        run: |
          echo "# Portable mode" > aseprite.ini
          7z a Aseprite-${{ steps.upstream.outputs.tag }}-Windows.zip *

      - name: Create Release
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.upstream.outputs.tag }}
          name: Aseprite ${{ steps.upstream.outputs.tag }}
          draft: false
          prerelease: false
          files: aseprite/build/bin/Aseprite-${{ steps.upstream.outputs.tag }}-Windows.zip